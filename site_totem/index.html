<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Language" content="pt-BR" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./assets/styles/mainStyles.css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <title>TOTEM DA QUALIDADE</title>
  </head>
  <body class="min-h-screen py-5 flex flex-col justify-between">
    <!-- 192.168.1.2 -->
    <!-- HEADER -->
    <header
      class="flex flex-col gap-y-6 tablet:gap-y-4 items-center justify-center mx-auto max-w-[90%]"
    >
      <div class="tablet:w-48">
        <img
          src="./assets/images/logo_ctc.jpeg"
          alt="LOGO-CTC"
          class="w-full"
        />
      </div>
      <h1
        class="text-3xl tablet:text-2xl w-full text-center text-[#A2823C] font-bold"
      >
        SELECIONE A OP√á√ÉO DESEJADA:
      </h1>
    </header>

    <!-- LISTA DE OP√á√ïES -->
    <main
      class="grid grid-cols-1 sm:grid-cols-2 gap-4 px-4 py-6 mx-auto max-w-[90%]"
    >
      <!-- OP√á√ïES -->
      <div
        onclick="openModal('POP')"
        class="cursor-pointer px-2 font-bold rounded-lg flex items-center justify-center w-full tablet:w-56 h-20 text-center bg-[#98B5A0] text-sm tablet:text-base"
      >
        CONSULTA DE PROCEDIMENTOS OPERACIONAIS (POP)
      </div>
      <div
        onclick="openModal('NC')"
        class="cursor-pointer px-2 font-bold rounded-lg flex items-center justify-center w-full tablet:w-56 h-20 text-center bg-[#98B5A0] text-sm tablet:text-base"
      >
        APONTAMENTO DE N√ÉO CONFORMIDADES (NC)
      </div>
      <div
        onclick="openModal('CHAMADO')"
        class="cursor-pointer px-2 font-bold rounded-lg flex items-center justify-center w-full tablet:w-56 h-20 text-center bg-[#98B5A0] text-sm tablet:text-base"
      >
        ABERTURA DE CHAMADO PARA QUALIDADE
      </div>
      <div
        onclick="openModal('MELHORIA')"
        class="cursor-pointer px-2 font-bold rounded-lg flex items-center justify-center w-full tablet:w-56 h-20 text-center bg-[#98B5A0] text-sm tablet:text-base"
      >
        PROPOSTA DE MELHORIA CONT√çNUA
      </div>
      <div
        onclick="openModal('MANUAIS')"
        class="cursor-pointer px-2 font-bold rounded-lg flex items-center justify-center w-full tablet:w-56 h-20 text-center bg-[#98B5A0] text-sm tablet:text-base"
      >
        CONSULTA DE MANUAIS E POL√çTICAS
      </div>
    </main>

    <!-- MODAL -->
    <div id="modal" class="modal">
      <div class="modal-content" style="width: 95%; max-width: 800px">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2
          id="modalTitle"
          class="text-xl tablet:text-2xl font-bold text-[#A2823C] mb-4"
        >
          CASTANHAL
        </h2>

        <div id="selectionView">
          <h3 class="text-lg tablet:text-xl font-semibold mb-4">
            SELECIONE O DOCUMENTO PARA CONSULTA:
          </h3>
          <div id="documentList" class="mb-6">
            <!-- Lista de documentos permanece igual -->
          </div>
        </div>

        <div id="viewer" style="display: none; height: 60vh">
          <iframe
            id="elementFrame"
            style="width: 100%; height: 100%; border: none"
          ></iframe>
          <button
            onclick="backToList()"
            class="cursor-pointer mt-4 bg-[#367049] text-white py-2 px-4 rounded text-sm tablet:text-base"
          >
            Voltar para lista
          </button>
        </div>
        <div class="text-center mt-4 justify-center">
          <button
            onclick="closeModal()"
            class="bg-[#367049] text-white p-2 rounded-lg cursor-pointer"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer class="p-1 rounded-lg text-center bg-[#E1D8B7] w-[50%] mx-auto">
      <span class="text-[#367049] font-bold text-sm tablet:text-base"
        >Gest√£o de Engenharia e Qualidade - Desenvolvido pela Equipe de TI da
        CTC</span
      >
    </footer>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    let pdfTree = {}; // JSON vindo do backend
    let currentPath = []; // Caminho atual (ex: ["POP","01-operacao_logistica"])

    async function getPdfs() {
      try {
        const res = await axios.get("http://localhost:3100/api/pdfs");
        pdfTreeResponse = res.data; // Armazena a estrutura
        pdfTree = {
          ...pdfTreeResponse,
          NC: {
            name: "Apontamento de n√£o conformidades (NC)",
            link: "https://forms.office.com/r/YHJFAueFtc",
          },
          MELHORIA: {
            name: "Proposta de melhoria cont√≠nua",
            link: "https://forms.office.com/r/UV1VNnJ8k0",
          },
        };
        console.log("PDF Tree:", pdfTree);
      } catch (err) {
        console.error("Erro ao buscar PDFs:", err);
      }
    }
    getPdfs();

    function openModal(category) {
      currentPath = [category]; // Ex.: ["POP"]
      updateModalView();
      document.getElementById("modal").style.display = "block";
    }

    function updateModalView() {
      const modalTitle = document.getElementById("modalTitle");
      const documentList = document.getElementById("documentList");
      const selectionView = document.getElementById("selectionView");
      const viewer = document.getElementById("viewer");

      viewer.style.display = "none";
      selectionView.style.display = "block";
      documentList.innerHTML = "";

      // Caminho atual no JSON
      let pointer = pdfTree;
      currentPath.forEach((p) => (pointer = pointer[p]));

      modalTitle.textContent = "üìÇ " + currentPath.join(" / ");

      // Pastas (subdiret√≥rios)
      for (const key in pointer) {
        if (key !== "name" && key !== "link" && key !== "files") {
          const folder = document.createElement("div");
          folder.className = "document-item";
          folder.innerHTML = `<i class="fas fa-folder pdf-icon"></i><span>${key}</span>`;
          folder.onclick = () => {
            currentPath.push(key);
            updateModalView();
          };
          documentList.appendChild(folder);
        }
      }

      if (pointer.link) {
        const forms = document.createElement("div");
        forms.className = "document-item";
        forms.innerHTML = `<i class="fas fa-link pdf-icon"></i><span>${pointer.name}</span>`;
        forms.onclick = () => {
          const link = pointer.link;
          showForms(link);
        };
        documentList.appendChild(forms);
      }

      // Arquivos (PDFs)
      if (pointer.files) {
        pointer.files.forEach((file) => {
          const pdf = document.createElement("div");
          pdf.className = "document-item";
          pdf.innerHTML = `<i class="fas fa-file-pdf pdf-icon"></i><span>${file.name}</span>`;

          pdf.onclick = () => {
            const path = currentPath.join("/") + "/" + file.name;
            showPdf(path);
          };
          documentList.appendChild(pdf);
        });
      }

      // Bot√£o de Voltar (se n√£o est√° na raiz)
      if (currentPath.length > 1) {
        const back = document.createElement("div");
        back.className = "document-item back";
        back.innerHTML = `<i class="fas fa-arrow-left pdf-icon"></i><span>Voltar</span>`;
        back.onclick = () => {
          currentPath.pop();
          updateModalView();
        };
        documentList.prepend(back);
      }
    }

    function showPdf(relativePath) {
      document.getElementById("selectionView").style.display = "none";
      const viewer = document.getElementById("viewer");
      const elementFrame = document.getElementById("elementFrame");
      // Usa Google Docs para preview em mobile/tablet
      const baseUrl = window.location.origin + "/pdfs/";

      elementFrame.src = `https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(
        baseUrl + relativePath
      )}`;

      viewer.style.display = "block";
    }

    function showForms(link) {
      document.getElementById("selectionView").style.display = "none";
      const viewer = document.getElementById("viewer");
      const elementFrame = document.getElementById("elementFrame");
      elementFrame.src = link;
      viewer.style.display = "block";
    }

    function backToList() {
      document.getElementById("viewer").style.display = "none";
      document.getElementById("selectionView").style.display = "block";
      document.getElementById("elementFrame").src = "";
    }

    function closeModal() {
      backToList();
      document.getElementById("modal").style.display = "none";
    }

    window.onclick = function (event) {
      const modal = document.getElementById("modal");
      if (event.target === modal) closeModal();
    };
  </script>
</html>
